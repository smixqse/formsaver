<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Gun from "gun/gun";
import SEA from "gun/sea"
import 'gun/lib/promise.js';

/**
 * Main FormSaver class
*/
class FormSaver {
    _gun;
    _keys;
    _user;
    _isUserAvailable = false;

    static newGunInstance = Gun;

    /**
     * FormSaver constructor
     * @param {object=} gun - An optional existing GUN instance
     */
    constructor (gun = Gun(["https://gun-eu.herokuapp.com/gun"])) {
        this._gun = gun;
    };

    /**
     * Submit an existing backup key
     * @param {string} backup - Encoded backup key
     * @returns {Promise&lt;string>} Confirmation of submission
     */
    submitBackup(backup) {
        return new Promise (async (resolve, reject) => {
            this._keys = JSON.parse(atob(backup));
            this._user = this._gun.user();
            this._user.auth(this._keys);
            this._user.pair = this._keys;
            this._isUserAvailable = true;
            setTimeout(() => {resolve("Submitted");}, 500);
        });
    };

    async _createUser() {
        const pair = await SEA.pair();
        this._keys = pair;
        this._user = this._gun.user();
        this._user.auth(pair);
        this._user.pair = pair;
        this._isUserAvailable = true;
    };

    /**
     * Get raw backup data
     * @returns {object} - Raw backup data
     */
    getRawBackup() {
        return new Promise (async (resolve, reject) => {
            if (!this._isUserAvailable) {reject("No user available"); return};
            const data = await SEA.decrypt((await this._user.get("formOptions").promOnce()).data, this._keys);
            if (data === null || data === undefined) {reject("Data is null");} else {resolve(data);};
        });

    };

    /**
     * Set raw backup data
     * @param {object} data - Raw data object to save
     * @returns {Promise&lt;string>} If resolved, your backup key
     */
    setRawBackup(data) {
        return new Promise (async (resolve, reject) => {
            if (!this._isUserAvailable) this._createUser();
            setTimeout(async () => {
                const sent = await this._user.get("formOptions").promPut(await SEA.encrypt(data, this._keys));
                resolve(btoa(JSON.stringify(this._keys)));
            }, 500)
        });
    };

    /**
     * Fetches your backup data and displays them on the form
     * @param {string | HTMLFormElement} form - Form name or form element
     * @returns {Promise&lt;object>} Fetched raw backup data
     */
    getBackup(form) {
        return new Promise((resolve, reject) => {
            if (!this._isUserAvailable) {reject("No user available"); return};
            setTimeout(async () => {
                var data = await SEA.decrypt((await this._user.get("formOptions").promOnce()).data, this._user.pair);
                var elem = {};
                if (typeof form === "string") {
                    elem = document.querySelector(`form[name=${form}]`) || {}
                } else {
                    element = form || {}
                };
                if (elem === {}) {
                    reject("Form element not found");
                    return
                };
                if (typeof data !== "object") {
                    reject("Fetched data isn't an object");
                    return
                };
                elem.querySelectorAll("input, select").forEach(function (element) {
                    if (Object.keys(data).includes(element.name)) {
                        if (data[element.name].type === "text") { 
                            element.value = data[element.name].val;
                        } else if (data[element.name].type === "radio" &amp;&amp; data[element.name].val === element.value) {
                            element.checked = true;
                        } else if (data[element.name].type === "select") {
                            element.value = data[element.name].val;
                        } else if (data[element.name].type === "check") {
                            element.checked = data[element.name].val;
                        };
                    };
                });
                resolve(data);
            }, 500);
        });
    };
    /**
     * Fetches your current form data and saves it to the backup
     * @param {string | HTMLFormElement} form - Form name or form element
     * @returns {Promise&lt;string>} If resolved, your backup key
     */
    setBackup(form) {
        return new Promise (async (resolve, reject) => {
            if (!this._isUserAvailable) this._createUser();
            var elem = {};
            if (typeof form === "string") {elem = document.querySelector(`form[name=${form}]`) || {}} else {element = form || {}};
            if (elem === {}) {reject("Form element not found"); return};
            var formToSend = {};
            elem.querySelectorAll("input, select").forEach(function (element) {
                if (element.type === "text") {
                    formToSend[element.name] = {
                        type: "text",
                        val: element.value
                    };
                } else if (element.type === "radio") {
                    if (element.checked) {
                        formToSend[element.name] = {
                            type: "radio",
                            val: element.value
                        };
                    } else {
                        if (!formToSend[element.name]) {
                            formToSend[element.name] = {
                                type: "radio",
                                val: ""
                            };
                        };
                    };
                } else if (element.tagName.toLowerCase() === "select") {
                    if (element.value.length > 0) {
                        formToSend[element.name] = {
                            type: "select",
                            val: element.value
                        };
                    } else {
                        if (!formToSend[element.name]) {
                            formToSend[element.name] = {
                                type: "select",
                                val: ""
                            };
                        };
                    };
                } else if (element.type === "checkbox") {
                    if (element.checked) {
                        formToSend[element.name] = {
                            type: "check",
                            val: true
                        };
                    } else {
                        if (!formToSend[element.name]) {
                            formToSend[element.name] = {
                                type: "check",
                                val: false
                            };
                        };
                    };
                };
            });
            setTimeout(async () => {
                const sent = await this._user.get("formOptions").promPut(await SEA.encrypt(formToSend, this._keys));
                resolve(btoa(JSON.stringify(this._keys)));
            }, 500);
        })
    };

    /**
     * Discards saved data to clean up memory
     */
    async discardBackup () {
        if (!this._isUserAvailable) return;
        await this._user.get("formOptions").promPut(null);
        this._user.delete();
        this._user = this._gun.user();
        this._isUserAvailable = false;
        this._keys = {};
        localStorage["gun/"] = {};
        localStorage["gap/gun/"] = {};
    };
};

if (window &amp;&amp; !window.FormSaver) window.FormSaver = FormSaver;

export default FormSaver;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FormSaver.html">FormSaver</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Fri Jun 26 2020 15:30:29 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
